version: "3.7"

services:
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: revenda-backend:latest
    restart: always

    networks:
      - network_public

    environment:
      - PORT=3000
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
      - DB_PORT=${DB_PORT}
      # JWT (mesmo secret do central-pelg)
      - JWT_SECRET=${JWT_SECRET}
      # iPag
      - IPAG_API_URL=${IPAG_API_URL}
      - IPAG_API_ID=${IPAG_API_ID}
      - IPAG_API_KEY=${IPAG_API_KEY}
      # API URL (para callbacks do iPag)
      - API_URL=${API_URL}
      # WooCommerce (patriciaelias.com.br)
      - WC_URL=${WC_URL}
      - WC_CONSUMER_KEY=${WC_CONSUMER_KEY}
      - WC_CONSUMER_SECRET=${WC_CONSUMER_SECRET}
      # SMTP (587 + STARTTLS)
      - SMTP_ADDRESS=${SMTP_ADDRESS}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_OPENSSL_VERIFY_MODE=${SMTP_OPENSSL_VERIFY_MODE}
      # Internal API (comunicacao com central-pelg)
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - CENTRAL_API_URL=${CENTRAL_API_URL}
      - FRONTEND_URL=${FRONTEND_URL}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.revenda-backend.rule=Host(`revenda.pelg.com.br`) && (PathPrefix(`/addresses`) || PathPrefix(`/orders`) || PathPrefix(`/payments`) || PathPrefix(`/users`) || PathPrefix(`/admin/dashboard`) || PathPrefix(`/admin/users`) || PathPrefix(`/admin/affiliates`) || PathPrefix(`/admin/orders`) || PathPrefix(`/admin/abandoned-carts`) || PathPrefix(`/admin/webhook-configurations`) || PathPrefix(`/admin/recovery-templates`) || PathPrefix(`/admin/app-settings`) || PathPrefix(`/admin/level-history`) || PathPrefix(`/admin/meta`) || PathPrefix(`/verification-codes`) || PathPrefix(`/abandoned-carts`) || PathPrefix(`/webhooks`) || PathPrefix(`/app-settings`) || PathPrefix(`/woocommerce`) || PathPrefix(`/kits`) || PathPrefix(`/referral`) || PathPrefix(`/rankings`) || PathPrefix(`/affiliate`) || PathPrefix(`/products`) || PathPrefix(`/admin/products`) || PathPrefix(`/cron`) || PathPrefix(`/auth`))
        - traefik.http.routers.revenda-backend.entrypoints=websecure
        - traefik.http.routers.revenda-backend.priority=2
        - traefik.http.routers.revenda-backend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.revenda-backend.service=revenda-backend
        - traefik.http.services.revenda-backend.loadbalancer.server.port=3000

  frontend:
    image: revenda-frontend:latest
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - network_public

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.revenda-frontend.rule=Host(`revenda.pelg.com.br`)
        - traefik.http.routers.revenda-frontend.entrypoints=websecure
        - traefik.http.routers.revenda-frontend.priority=1
        - traefik.http.routers.revenda-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.revenda-frontend.service=revenda-frontend
        - traefik.http.services.revenda-frontend.loadbalancer.server.port=80

networks:
  network_public:
    external: true
