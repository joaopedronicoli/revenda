version: "3.7"

services:
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: revenda-backend:latest
    restart: always

    networks:
      - network_public

    environment:
      - PORT=3000
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
      - DB_PORT=${DB_PORT}
      # JWT (mesmo secret do central-pelg)
      - JWT_SECRET=${JWT_SECRET}
      # iPag
      - IPAG_API_URL=${IPAG_API_URL}
      - IPAG_API_ID=${IPAG_API_ID}
      - IPAG_API_KEY=${IPAG_API_KEY}
      # API URL (para callbacks do iPag)
      - API_URL=${API_URL}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.revenda-backend.rule=Host(`revenda.pelg.com.br`) && (PathPrefix(`/addresses`) || PathPrefix(`/orders`) || PathPrefix(`/payments`) || PathPrefix(`/users`) || PathPrefix(`/admin`) || PathPrefix(`/verification-codes`) || PathPrefix(`/abandoned-carts`) || PathPrefix(`/webhooks`) || PathPrefix(`/app-settings`))
        - traefik.http.routers.revenda-backend.entrypoints=websecure
        - traefik.http.routers.revenda-backend.priority=2
        - traefik.http.routers.revenda-backend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.revenda-backend.service=revenda-backend
        - traefik.http.services.revenda-backend.loadbalancer.server.port=3000

  frontend:
    image: revenda-frontend:latest
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - network_public

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.revenda-frontend.rule=Host(`revenda.pelg.com.br`)
        - traefik.http.routers.revenda-frontend.entrypoints=websecure
        - traefik.http.routers.revenda-frontend.priority=1
        - traefik.http.routers.revenda-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.revenda-frontend.service=revenda-frontend
        - traefik.http.services.revenda-frontend.loadbalancer.server.port=80

networks:
  network_public:
    external: true
